# Simple NGINX configuration with Paygress auth
server {
    listen 80;
    server_name api.example.com;

    # Protected location
    location /premium {
        # Call Paygress for authentication
        auth_request /auth-paygress;
        
        # Forward to your backend service
        proxy_pass http://backend-service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Internal auth endpoint
    location = /auth-paygress {
        internal;
        
        # Call Paygress auth service
        proxy_pass http://paygress:8080/auth;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Method $request_method;
        
        # Pass token from query parameter or header
        # Token can be: ?token=cashuAbc123&amount=5000
        # Or: Authorization: Bearer cashuAbc123
    }

    # Error page for payment required
    error_page 402 = @payment_required;
    location @payment_required {
        return 402 '{"error":"Payment required","message":"Please provide a valid Cashu token"}';
        add_header Content-Type application/json;
    }
}
