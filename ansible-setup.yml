---
- name: Setup Ubuntu machine with Docker, Kubernetes, and Paygress
  hosts: all
  become: yes
  vars:
    kubernetes_version: "1.28"
    containerd_version: "1.6.24"
    paygress_user: "{{ ansible_user }}"
    paygress_dir: "/home/{{ paygress_user }}/paygress"
    # All configuration variables are defined in inventory.ini
    # public_ip, ssh_port_start, ssh_port_end, main_service_port
    
  tasks:
    # ===============================
    # System Prerequisites
    # ===============================
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - software-properties-common
          - git
          - build-essential
          - pkg-config
          - libssl-dev
          - unzip
        state: present

    # ===============================
    # Docker Installation
    # ===============================
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: Add user to docker group
      user:
        name: "{{ paygress_user }}"
        groups: docker
        append: yes

    - name: Start and enable Docker
      systemd:
        name: docker
        state: started
        enabled: yes

    # ===============================
    # Kubernetes Installation
    # ===============================
    - name: Add Kubernetes GPG key
      apt_key:
        url: https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/Release.key
        state: present

    - name: Add Kubernetes repository
      apt_repository:
        repo: "deb https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/ /"
        state: present

    - name: Install Kubernetes packages
      apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present

    - name: Hold Kubernetes packages
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop:
        - kubelet
        - kubeadm
        - kubectl

    # ===============================
    # Configure containerd
    # ===============================
    - name: Create containerd config directory
      file:
        path: /etc/containerd
        state: directory

    - name: Generate containerd config
      shell: containerd config default > /etc/containerd/config.toml

    - name: Configure systemd cgroup driver
      replace:
        path: /etc/containerd/config.toml
        regexp: 'SystemdCgroup = false'
        replace: 'SystemdCgroup = true'

    - name: Restart containerd
      systemd:
        name: containerd
        state: restarted
        enabled: yes

    # ===============================
    # Configure Firewall (Before Kubernetes)
    # ===============================
    - name: Install ufw
      apt:
        name: ufw
        state: present

    - name: Allow SSH
      ufw:
        rule: allow
        port: '{{ ansible_ssh_port | default(22) }}'
        proto: tcp

    - name: Allow Kubernetes API
      ufw:
        rule: allow
        port: '6443'
        proto: tcp

    - name: Allow NodePort range
      ufw:
        rule: allow
        port: '30000:32767'
        proto: tcp

    - name: Allow Paygress SSH pods
      ufw:
        rule: allow
        port: '{{ ssh_port_start }}:{{ ssh_port_end }}'
        proto: tcp

    - name: Allow all traffic from localhost
      ufw:
        rule: allow
        from_ip: '127.0.0.1'

    - name: Enable firewall
      ufw:
        state: enabled

    # ===============================
    # Kubernetes Cluster Setup
    # ===============================
    - name: Disable swap
      shell: swapoff -a

    - name: Remove swap from fstab
      replace:
        path: /etc/fstab
        regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
        replace: '# \1'

    - name: Load kernel modules
      modprobe:
        name: "{{ item }}"
      loop:
        - overlay
        - br_netfilter

    - name: Create modules-load config
      copy:
        content: |
          overlay
          br_netfilter
        dest: /etc/modules-load.d/k8s.conf

    - name: Configure sysctl for Kubernetes
      copy:
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1
        dest: /etc/sysctl.d/k8s.conf

    - name: Apply sysctl settings
      shell: sysctl --system

    # ===============================
    # Ensure Kubernetes Services are Running
    # ===============================
    - name: Ensure containerd is running
      systemd:
        name: containerd
        state: started
        enabled: yes

    - name: Ensure kubelet is running
      systemd:
        name: kubelet
        state: started
        enabled: yes

    - name: Initialize Kubernetes cluster
      shell: |
        kubeadm init --pod-network-cidr=10.244.0.0/16 || true
      register: kubeadm_init
      ignore_errors: yes

    - name: Create .kube directory
      file:
        path: "/home/{{ paygress_user }}/.kube"
        state: directory
        owner: "{{ paygress_user }}"
        group: "{{ paygress_user }}"

    - name: Copy kubeconfig
      copy:
        src: /etc/kubernetes/admin.conf
        dest: "/home/{{ paygress_user }}/.kube/config"
        owner: "{{ paygress_user }}"
        group: "{{ paygress_user }}"
        remote_src: yes

    # ===============================
    # Install CNI (Flannel)
    # ===============================
    - name: Check if API server is accessible
      shell: kubectl cluster-info --request-timeout=3s
      register: api_check
      ignore_errors: yes
      become_user: "{{ paygress_user }}"

    - name: Reset Kubernetes if API not accessible
      shell: kubeadm reset --force
      when: api_check.rc != 0

    - name: Reinitialize Kubernetes cluster if needed
      shell: |
        kubeadm init --pod-network-cidr=10.244.0.0/16
      when: api_check.rc != 0
      ignore_errors: yes

    - name: Recreate .kube directory if needed
      file:
        path: "/home/{{ paygress_user }}/.kube"
        state: directory
        owner: "{{ paygress_user }}"
        group: "{{ paygress_user }}"
      when: api_check.rc != 0

    - name: Copy kubeconfig if reinitialized
      copy:
        src: /etc/kubernetes/admin.conf
        dest: "/home/{{ paygress_user }}/.kube/config"
        owner: "{{ paygress_user }}"
        group: "{{ paygress_user }}"
        remote_src: yes
      when: api_check.rc != 0

    - name: Wait for API server after reset
      shell: kubectl cluster-info --request-timeout=5s
      register: api_ready
      retries: 12
      delay: 10
      until: api_ready.rc == 0
      ignore_errors: yes
      become_user: "{{ paygress_user }}"
      when: api_check.rc != 0

    - name: Install Flannel CNI
      become_user: "{{ paygress_user }}"
      shell: kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

    - name: Wait a bit for Flannel to initialize
      pause:
        seconds: 30

    - name: Remove taint from control-plane (single node setup)
      become_user: "{{ paygress_user }}"
      shell: kubectl taint nodes --all node-role.kubernetes.io/control-plane- || true

    # ===============================
    # Install Rust
    # ===============================
    - name: Download Rust installer
      get_url:
        url: https://sh.rustup.rs
        dest: /tmp/rust-installer.sh
        mode: '0755'

    - name: Install Rust
      become_user: "{{ paygress_user }}"
      shell: /tmp/rust-installer.sh -y

    - name: Add Rust to PATH
      lineinfile:
        path: "/home/{{ paygress_user }}/.bashrc"
        line: 'export PATH="$HOME/.cargo/bin:$PATH"'

    # ===============================
    # Clone and Setup Paygress
    # ===============================
    - name: Remove existing paygress directory
      file:
        path: "{{ paygress_dir }}"
        state: absent

    - name: Clone paygress repository
      become_user: "{{ paygress_user }}"
      git:
        repo: https://github.com/DhananjayPurohit/paygress.git
        dest: "{{ paygress_dir }}"
        version: feat/nip04

    - name: Create user-workloads namespace
      become_user: "{{ paygress_user }}"
      shell: |
        . ~/.cargo/env
        kubectl create namespace user-workloads || true
      args:
        chdir: "{{ paygress_dir }}"

    # ===============================
    # Configure Paygress Environment
    # ===============================
    - name: Copy .env.template to .env
      become_user: "{{ paygress_user }}"
      shell: "cp {{ paygress_dir }}/.env.template {{ paygress_dir }}/.env && chmod 600 {{ paygress_dir }}/.env"
      args:
        chdir: "{{ paygress_dir }}"

    - name: Update .env with server IP
      become_user: "{{ paygress_user }}"
      replace:
        path: "{{ paygress_dir }}/.env"
        regexp: 'SSH_HOST=.*'
        replace: 'SSH_HOST={{ public_ip }}'

    - name: Update paygress.env with correct data path
      become_user: "{{ paygress_user }}"
      replace:
        path: "{{ paygress_dir }}/.env"
        regexp: 'CASHU_DB_PATH=.*'
        replace: 'CASHU_DB_PATH={{ paygress_dir }}/data/cashu.db'

    - name: Update paygress.env with Nostr relays
      become_user: "{{ paygress_user }}"
      replace:
        path: "{{ paygress_dir }}/.env"
        regexp: 'NOSTR_RELAYS=.*'
        replace: 'NOSTR_RELAYS={{ nostr_relays }}'

    - name: Update paygress.env with Nostr private key
      become_user: "{{ paygress_user }}"
      replace:
        path: "{{ paygress_dir }}/.env"
        regexp: 'NOSTR_PRIVATE_KEY=.*'
        replace: 'NOSTR_PRIVATE_KEY={{ nostr_private_key }}'

    - name: Update paygress.env with whitelisted mints
      become_user: "{{ paygress_user }}"
      replace:
        path: "{{ paygress_dir }}/.env"
        regexp: 'WHITELISTED_MINTS=.*'
        replace: 'WHITELISTED_MINTS={{ whitelisted_mints }}'

    - name: Update port range for production
      become_user: "{{ paygress_user }}"
      replace:
        path: "{{ paygress_dir }}/.env"
        regexp: 'SSH_PORT_RANGE_START=.*'
        replace: 'SSH_PORT_RANGE_START={{ ssh_port_start }}'

    - name: Update port range end for production
      become_user: "{{ paygress_user }}"
      replace:
        path: "{{ paygress_dir }}/.env"
        regexp: 'SSH_PORT_RANGE_END=.*'
        replace: 'SSH_PORT_RANGE_END={{ ssh_port_end }}'

    - name: Update interface configuration - Nostr
      become_user: "{{ paygress_user }}"
      replace:
        path: "{{ paygress_dir }}/.env"
        regexp: 'ENABLE_NOSTR=.*'
        replace: 'ENABLE_NOSTR={{ enable_nostr }}'

    - name: Update interface configuration - MCP
      become_user: "{{ paygress_user }}"
      replace:
        path: "{{ paygress_dir }}/.env"
        regexp: 'ENABLE_MCP=.*'
        replace: 'ENABLE_MCP={{ enable_mcp }}'

    - name: Update interface configuration - HTTP
      become_user: "{{ paygress_user }}"
      replace:
        path: "{{ paygress_dir }}/.env"
        regexp: 'ENABLE_HTTP=.*'
        replace: 'ENABLE_HTTP={{ enable_http }}'

    - name: Update HTTP port configuration
      become_user: "{{ paygress_user }}"
      replace:
        path: "{{ paygress_dir }}/.env"
        regexp: 'HTTP_PORT=.*'
        replace: 'HTTP_PORT={{ http_port }}'

    - name: Update HTTP bind address configuration
      become_user: "{{ paygress_user }}"
      replace:
        path: "{{ paygress_dir }}/.env"
        regexp: 'HTTP_BIND_ADDR=.*'
        replace: 'HTTP_BIND_ADDR={{ http_bind_addr }}'

    # ===============================
    # Build and Deploy Paygress
    # ===============================
    - name: Build unified paygress service
      become_user: "{{ paygress_user }}"
      shell: |
        . ~/.cargo/env
        cargo build --release --bin paygress
      args:
        chdir: "{{ paygress_dir }}"

    # ===============================
    # Create Systemd Service
    # ===============================
    - name: Create paygress data directory
      file:
        path: "{{ paygress_dir }}/data"
        state: directory
        owner: "{{ paygress_user }}"
        group: "{{ paygress_user }}"
        mode: '0755'

    - name: Create unified paygress systemd service
      copy:
        content: |
          [Unit]
          Description=Paygress Unified Service (Nostr + MCP + HTTP)
          After=network.target docker.service
          Requires=docker.service

          [Service]
          Type=simple
          User={{ paygress_user }}
          WorkingDirectory={{ paygress_dir }}
          ExecStartPre=/bin/mkdir -p {{ paygress_dir }}/data
          ExecStart={{ paygress_dir }}/target/release/paygress
          Restart=always
          RestartSec=10
          Environment=PATH=/home/{{ paygress_user }}/.cargo/bin:/usr/local/bin:/usr/bin:/bin

          # Load environment variables
          EnvironmentFile={{ paygress_dir }}/.env

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/paygress.service
      notify: restart paygress

    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Enable paygress service
      systemd:
        name: paygress
        enabled: yes
        state: started



    # ===============================
    # Final Setup Instructions
    # ===============================
    - name: Create setup completion script
      copy:
        content: |
          #!/bin/bash
          echo "üéâ Paygress setup completed!"
          echo ""
          echo "üìã Next steps:"
          echo "1. Configure your settings in inventory.ini:"
          echo "   - Set nostr_private_key to your actual private key"
          echo "   - Verify nostr_relays and whitelisted_mints"
          echo "   - Update public_ip with your server public IP"
          echo "2. Re-run ansible-playbook ansible-setup.yml to apply changes"
          echo "3. Check service status: sudo systemctl status paygress"
          echo "4. View logs: sudo journalctl -u paygress -f"
          echo ""
          echo "üåê Unified service running:"
          echo "   - Nostr interface: Listen for NIP-17 encrypted messages on configured relays"
          echo "   - MCP interface: Context VM integration via Model Context Protocol"
          echo "   - HTTP interface: REST API endpoints for pod provisioning"
          echo "   - Service public key available in logs: sudo journalctl -u paygress -f"
          echo ""
          echo "ü§ñ Context VM Integration:"
          echo "   - MCP interface running on stdio transport"
          echo "   - Available tools: spawn_pod, topup_pod, list_pods, get_offers"
          echo "   - Use gateway-cli to connect: gateway-cli --server ./start-paygress-context-vm.sh"
          echo ""
          echo "üåê HTTP API Endpoints:"
          echo "   - Health check: http://{{ public_ip }}:8080/health"
          echo "   - Get offers: http://{{ public_ip }}:8080/offers"
          echo "   - List pods: http://{{ public_ip }}:8080/pods"
          echo "   - Spawn pod: POST http://{{ public_ip }}:8080/pods/spawn"
          echo "   - Topup pod: POST http://{{ public_ip }}:8080/pods/topup"
          echo ""
          echo "üîê SSH pods will be accessible at:"
          echo "   ssh user@{{ public_ip }} -p <allocated-port>"
          echo ""
          echo "üìÅ Paygress directory: {{ paygress_dir }}"
          echo "‚öôÔ∏è  Configuration file: {{ paygress_dir }}/.env"
        dest: "/home/{{ paygress_user }}/setup-complete.sh"
        mode: '0755'
        owner: "{{ paygress_user }}"
        group: "{{ paygress_user }}"

    # ===============================
    # Context VM Gateway Setup
    # ===============================
    - name: Install Node.js and npm (for gateway-cli)
      apt:
        name:
          - nodejs
          - npm
        state: present

    - name: Install gateway-cli globally
      npm:
        name: "@contextvm/gateway-cli"
        global: yes
      ignore_errors: yes

    - name: Create Context VM startup script
      copy:
        dest: "/home/{{ paygress_user }}/start-contextvm.sh"
        content: |
          #!/bin/bash
          cd /home/{{ paygress_user }}/paygress
          
          # Check if gateway-cli is available
          if ! command -v gateway-cli &> /dev/null; then
              echo "Installing gateway-cli..."
              npm install -g @contextvm/gateway-cli
          fi
          
          # Start Context VM with Paygress
          gateway-cli \
            --private-key "5747e39e96339baf8484d9a503286c302aff8ee88c796812839e2dccf9b75dfe" \
            --relays "wss://relay.contextvm.org" \
            --server ./start-paygress.sh
        owner: "{{ paygress_user }}"
        group: "{{ paygress_user }}"
        mode: '0755'

    - name: Create systemd service for Context VM
      copy:
        dest: /etc/systemd/system/contextvm.service
        content: |
          [Unit]
          Description=Context VM Gateway for Paygress
          After=paygress.service
          Wants=paygress.service

          [Service]
          Type=simple
          User={{ paygress_user }}
          WorkingDirectory=/home/{{ paygress_user }}/paygress
          ExecStart=/home/{{ paygress_user }}/start-contextvm.sh
          Restart=always
          RestartSec=10
          Environment=NODE_ENV=production

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd daemon for Context VM
      systemd:
        daemon_reload: yes

    - name: Enable and start Context VM service
      systemd:
        name: contextvm
        enabled: yes
        state: started

    - name: Show Context VM service status
      shell: systemctl status contextvm --no-pager || true
      register: contextvm_status

    - name: Display Context VM status
      debug:
        msg: "{{ contextvm_status.stdout_lines }}"

  handlers:
    - name: restart paygress
      systemd:
        name: paygress
        state: restarted

    - name: restart docker
      systemd:
        name: docker
        state: restarted

    - name: restart kubelet
      systemd:
        name: kubelet
        state: restarted

    # ===============================
    # Final Kubernetes Health Check
    # ===============================
    - name: Final check - Ensure Kubernetes is running
      shell: kubectl cluster-info --request-timeout=10s
      register: final_k8s_check
      ignore_errors: yes
      become_user: "{{ paygress_user }}"

    - name: Show Kubernetes status
      debug:
        msg: "Kubernetes cluster status: {{ final_k8s_check.stdout if final_k8s_check.rc == 0 else 'NOT RUNNING' }}"

    - name: Show Kubernetes nodes
      shell: kubectl get nodes
      register: k8s_nodes
      ignore_errors: yes
      become_user: "{{ paygress_user }}"

    - name: Display Kubernetes nodes
      debug:
        msg: "{{ k8s_nodes.stdout_lines }}"
      when: k8s_nodes.rc == 0