# Paygress HTTP API with L402 Paywall
upstream paygress_backend {
    server paygress:8080;
}

server {
    listen 80;
    server_name _;

    # Health check endpoint (no paywall)
    location /health {
        proxy_pass http://paygress_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Public read endpoint (no paywall)
    location /offers {
        proxy_pass http://paygress_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Paywalled endpoint: Spawn Pod
    location /pods/spawn {
        # L402 Cashu payment enforcement
        l402 on;
        l402_amount_msat_default 6000;  # 6 sats minimum
        l402_macaroon_timeout 0;
        
        # Pass request to backend
        proxy_pass http://paygress_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Paywalled endpoint: Topup Pod
    location /pods/topup {
        # L402 Cashu payment enforcement
        l402 on;
        l402_amount_msat_default 6000;  # 6 sats minimum (comment said 100 sats in ansible, code said 6000 msat = 6 sats?)
        # Ansible comment: "100 sats minimum", code: "6000"; 6000 msat is 6 sats. 
        # I'll stick to the ansible code value 6000.
        l402_macaroon_timeout 3600;
        
        # Pass request to backend
        proxy_pass http://paygress_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Default: proxy all other requests (no paywall for now)
    location / {
        proxy_pass http://paygress_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
